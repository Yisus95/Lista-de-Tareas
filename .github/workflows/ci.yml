name: CI - minimal

on:
  push:
    branches: [ main, "**" ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies (from repo root)
        run: |
          python -m pip install --upgrade pip
          # instalar desde requirements.txt si existe
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt || (echo "pip install -r requirements.txt failed" && pip install "Django>=5.2,<6")
          else
            echo "requirements.txt not found in repo root"
            pip install "Django>=5.2,<6"
          fi
          # aseguramos pytest y pytest-django
          pip install pytest pytest-django
          echo "=== pip freeze ==="
          pip freeze

      - name: Debug pytest discovery
        run: |
          echo "=== Debug: working dir & listings ==="
          pwd
          echo "--- root listing ---"
          ls -la
          echo "--- src listing ---"
          ls -la src || true
          echo "--- src/proyecto listing ---"
          ls -la src/proyecto || true
          echo "=== Python info ==="
          python --version
          python -c "import sys, pathlib; print('cwd', pathlib.Path.cwd()); print('sys.path (first 5):', sys.path[:5])"
          python -c "import pytest; print('pytest', pytest.__version__, 'from', pytest.__file__)" || true
          echo "=== pytest config (from repo root) ==="
          pytest --showconfig || true
          echo "=== pytest collect-only (from root) ==="
          pytest --collect-only -q || true
          echo "=== pytest collect-only (from src/proyecto) ==="
          (cd src/proyecto && pytest --collect-only -q) || true

      - name: Verify Django installed
        run: |
          python -c "import django; print('Django', django.get_version())"

      - name: Run migrations
        run: |
          python src/proyecto/manage.py migrate --noinput

      - name: Run tests (debug)
        env:
          DJANGO_SETTINGS_MODULE: proyecto.settings
          PYTHONPATH: src/proyecto
        run: |
          echo "=== PWD ==="
          pwd
          echo "=== Root listing ==="
          ls -la
          echo "=== src/proyecto listing (first levels) ==="
          ls -la src/proyecto || true

          echo "=== Show pytest.ini (if present) ==="
          if [ -f pytest.ini ]; then sed -n '1,200p' pytest.ini; else echo "pytest.ini not found in repo root"; fi

          echo "=== Find test files ==="
          find src/proyecto -maxdepth 4 -type f \( -name 'test_*.py' -o -name '*_test.py' -o -name 'tests.py' \) -print | sed -n '1,200p' || true

          echo "=== Python import checks ==="
          python -c "import sys, importlib, pathlib; print('sys.path (head):', sys.path[:6]); print('can import proyecto?'); \
            import importlib.util; print(importlib.util.find_spec('proyecto'))" || true

          echo "=== pytest --showconfig ==="
          pytest --showconfig || true

          echo "=== pytest collect-only (root) ==="
          pytest --collect-only -q || true

          echo "=== pytest collect-only (inside src/proyecto) ==="
          (cd src/proyecto && pytest --collect-only -q) || true

          echo "=== If tests found, run pytest ==="
          pytest -q || echo "pytest returned $? (collection/run failed)"
